# 株式・投資信託 価格取得 → OFX出力アプリ 仕様書（最新版）

## 1. 概要
本アプリは、ユーザが指定した日付と複数の銘柄コード（日本株／米国株・ETF／日本の投資信託）に基づき、指定日の終値または基準価額を取得し、表形式で確認後、OFX形式のファイルとして出力する。

---

## 2. 対象資産と入力形式

### 2.1 日本株（取引所サフィックス対応）
- 入力形式例：
  - `7203.T`（東京証券取引所）
  - `1234.O`（大阪証券取引所）
  - `9999.N`（名古屋証券取引所）
- 形式：**銘柄コード + `.サフィックス`**
- サフィックス一覧：
  - `.T` … 東京証券取引所
  - `.O` … 大阪証券取引所
  - `.N` … 名古屋証券取引所
  - `.F` … 福岡証券取引所
  - `.S` … 札幌証券取引所

### 2.2 米国株・米国ETF
- 入力形式例：
  - `AAPL`（Apple Inc.）
  - `MSFT`（Microsoft Corporation）
  - `VT`（Vanguard Total World Stock ETF）
  - `VYM`（Vanguard High Dividend Yield ETF）
- 形式：英字ティッカー（サフィックス不要）

### 2.3 日本の公募投資信託
- 入力形式例：ファンドコード（例：`09311017`）
- 取得値：指定日の**基準価額（NAV）**

---

## 3. 動作概要
1. ユーザが銘柄コードリストと日付を入力する  
2. プログラムが銘柄コードの形式・特徴に基づき銘柄種別を自動判別する  
3. 銘柄種別に応じたデータソース（API/スクレイピング）から指定日の価格を取得  
4. 取得した情報を表形式で表示  
   - 表示項目：
     - ユーザ入力銘柄コード
     - 指定日付
     - 取得銘柄名
     - 取得価格（終値または基準価額）
     - 通貨（例：JPY, USD）
5. 表示後、全ての取得データをOFX形式に変換  
6. OFXファイルとして出力  

---

## 4. 入力仕様
- **必須**：
  - 日付（`YYYY-MM-DD`）
  - 銘柄コード（複数可、カンマ区切り）
- **不要**：
  - 複数日付の一括取得（単一日付のみ対応）

---

## 5. 出力仕様（OFX）
- **形式**：OFX（XML/SGML互換、参考仕様：[beatrek OFX spec](https://www.beatrek.com/home/ofxspec.htm)）
- **ファイル名**：
  - 複数銘柄：`SecuOFX_YYYYMMDD.ofx`
  - 単一銘柄：`SecuOFX_YYYYMMDD_<SYMBOL>.ofx`
- **参考サンプル**：
  - `SecuOFX_20240222_ANAHD.ofx`（2024/02/22 ANA HD 終値 2,000円）
  - `SecuOFX_20250808.ofx`（2025/08/08 日本投信 7銘柄 基準価額）
- **主要タグ例**：
  - `<CURDEF>` … 通貨コード（例：JPY, USD）
  - `<SECID>`  
    - `<UNIQUEID>` … 銘柄コード
    - `<UNIQUEIDTYPE>` … 銘柄種別識別子（例：TSE, MUTF, NASDAQ）
  - `<SECNAME>` … 銘柄名
  - `<UNITPRICE>` … 終値または基準価額
  - `<DTASOF>` … 価格日付（`YYYYMMDD`または`YYYYMMDDHHMMSS`）

---

## 6. データ取得仕様
- **日本株**：Yahoo! Finance Japan 等
- **米国株・米国ETF**：Yahoo! Finance US 等
- **日本の投資信託**：モーニングスター、運用会社公開データ等
- 取得値は指定日の終値/NAV（市場休業日は「取得不可」として扱う）

---

## 7. 表示仕様（表形式）
| 入力銘柄コード | 指定日付 | 取得銘柄名 | 取得価格（終値/基準価額） | 通貨 |
|---|---|---|---|---|
| 7203.T | 2025-08-08 | トヨタ自動車 | 3,000.00 | JPY |
| AAPL | 2025-08-08 | Apple Inc. | 220.15 | USD |
| 09311017 | 2025-08-08 | ○○ファンド | 11,234.56 | JPY |

- 取得不可の場合は価格・通貨を「—」表示し、理由を別途表示。

---

## 8. 自動判別ロジック
- `^\d{4}\.(T|O|N|F|S)$` → **日本株**
- `^\d{6,8}$` → **日本の投資信託**
- `^[A-Z][A-Z0-9\.-]{0,9}$` → **米国株/ETF**
- 上記に該当しない場合は入力不正としてスキップ

---

## 9. エラー処理
- **データ未取得**（休業日・コード不正・API応答なし）：
  - 表では価格・通貨を「—」表示
  - OFX変換時はスキップし、ログに記録
- **ネットワーク/APIエラー**：
  - 最大3回再試行、失敗時はログと画面に通知
- **入力不正**：
  - 正規表現チェックで警告し、該当銘柄を除外

---

## 10. 実装メモ
- 言語：Python 3.10+
- 主要ライブラリ：
  - `yfinance`（株価取得）
  - `requests` + `BeautifulSoup4`（スクレイピング）
- OFX生成：テンプレート文字列による構築（添付サンプルに準拠）
